<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîê Set New Password - Green Guard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

    <!-- Firebase (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: rgba(105, 249, 2, 0.2);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #388E3C;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error-message {
            color: #f44336;
            font-size: 0.9rem;
            margin-top: 5px;
            text-align: center;
        }

        .success-message {
            color: #4CAF50;
            font-size: 0.9rem;
            margin-top: 5px;
            text-align: center;
        }

        .info-box {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #2e7d32;
        }

        .password-requirements {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .password-strength {
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .strength-weak { color: #f44336; }
        .strength-medium { color: #ff9800; }
        .strength-strong { color: #4CAF50; }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #6c757d;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>üîê Set New Password</h2>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è Password Reset:</strong><br>
            Enter your new password below. Make sure it's secure and easy to remember.
        </div>

        <input type="password" id="newPassword" placeholder="üîí New Password" required>
        <input type="password" id="confirmPassword" placeholder="üîí Confirm New Password" required>
        
        <div class="password-requirements">
            <strong>Password Requirements:</strong><br>
            ‚Ä¢ At least 6 characters long<br>
            ‚Ä¢ Include letters and numbers<br>
            ‚Ä¢ Avoid common passwords
        </div>

        <div class="password-strength" id="passwordStrength"></div>
        
        <button onclick="updatePassword()" id="updateBtn">‚úÖ Update Password</button>
        <div id="message"></div>

        <div class="debug-info" id="debugInfo" style="display: none;">
            <strong>Debug Info:</strong><br>
            <div id="debugContent"></div>
        </div>
    </div>

    <script>
        // ‚úÖ Firebase config (matching register.html exactly)
        const firebaseConfig = {
            apiKey: "AIzaSyAhkb7NJbm_iaYrEyzS_G9quAbk3rIHkLM",
            authDomain: "greenguard-408ed.firebaseapp.com",
            projectId: "greenguard-408ed"
        };

        // ‚úÖ Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById("message");
            messageDiv.innerHTML = message;
            messageDiv.className = isError ? "error-message" : "success-message";
        }

        function setLoading(isLoading) {
            const button = document.getElementById('updateBtn');
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<span class="loading"></span>Updating...';
            } else {
                button.disabled = false;
                button.innerHTML = '‚úÖ Update Password';
            }
        }

        function showDebugInfo(content) {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = content;
            debugDiv.style.display = 'block';
        }

        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthDiv.innerHTML = '';
                return;
            }

            let strength = 0;
            let feedback = '';

            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            if (strength < 3) {
                feedback = 'Weak password';
                strengthDiv.className = 'password-strength strength-weak';
            } else if (strength < 5) {
                feedback = 'Medium strength password';
                strengthDiv.className = 'password-strength strength-medium';
            } else {
                feedback = 'Strong password';
                strengthDiv.className = 'password-strength strength-strong';
            }

            strengthDiv.innerHTML = feedback;
        }

        async function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!newPassword || !confirmPassword) {
                showMessage("‚ùå Please fill in both password fields", true);
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage("‚ùå Passwords do not match", true);
                return;
            }

            if (newPassword.length < 6) {
                showMessage("‚ùå Password must be at least 6 characters long", true);
                return;
            }

            setLoading(true);

            let debugInfo = `Password length: ${newPassword.length}\n`;

            try {
                // ‚úÖ Get the reset code from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const oobCode = urlParams.get('oobCode');
                
                debugInfo += `oobCode found: ${oobCode ? 'Yes' : 'No'}\n`;
                
                if (oobCode) {
                    debugInfo += `Step 1: Using oobCode to reset password...\n`;
                    
                    // ‚úÖ Use the reset code to confirm password reset
                    await auth.confirmPasswordReset(oobCode, newPassword);
                    
                    debugInfo += `‚úÖ Password reset confirmed successfully!\n`;
                    showMessage("‚úÖ Password updated successfully! Redirecting to login...", false);
                    showDebugInfo(debugInfo);
                    
                    // Redirect after a delay
                    setTimeout(() => {
                        window.location.href = "/templates/login.html";
                    }, 2000);
                    return;
                } else {
                    throw new Error("No reset code found. Please use the link from your email.");
                }

            } catch (error) {
                console.error("Error updating password:", error);
                debugInfo += `‚ùå Error: ${error.code} - ${error.message}\n`;
                
                if (error.code === 'auth/weak-password') {
                    showMessage("‚ùå Password is too weak. Please choose a stronger password.", true);
                } else if (error.code === 'auth/invalid-action-code') {
                    showMessage("‚ùå Invalid or expired reset link. Please request a new password reset.", true);
                } else if (error.code === 'auth/expired-action-code') {
                    showMessage("‚ùå Reset link has expired. Please request a new password reset.", true);
                } else if (error.code === 'auth/requires-recent-login') {
                    showMessage("‚ùå Security check required. Please use the reset link from your email.", true);
                } else {
                    showMessage("‚ùå " + (error.message || "Failed to update password. Please try again."), true);
                }
                
                showDebugInfo(debugInfo);
            } finally {
                setLoading(false);
            }
        }

        // ‚úÖ Add event listeners
        document.getElementById('newPassword').addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });

        document.getElementById('newPassword').addEventListener('keypress', function(e) {
            if (e.key === "Enter") {
                updatePassword();
            }
        });

        document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
            if (e.key === "Enter") {
                updatePassword();
            }
        });

        // ‚úÖ Check URL parameters on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const oobCode = urlParams.get('oobCode');
            const mode = urlParams.get('mode');
            
            console.log("Page loaded with parameters:");
            console.log("Mode:", mode);
            console.log("oobCode:", oobCode ? "Present" : "Not found");
            
            if (!oobCode) {
                showMessage("‚ùå Invalid reset link. Please use the link from your email.", true);
            }
        });

        // ‚úÖ Log initial setup
        console.log("Reset password page loaded");
        console.log("Firebase config:", firebaseConfig);
        console.log("Firebase Auth initialized:", !!auth);
    </script>

</body>

</html> 